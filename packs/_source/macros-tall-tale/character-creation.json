{
  "_id": "euVqlYfll65zKOew",
  "name": "Character creation",
  "type": "script",
  "author": "pdXclp2r5tiEF79G",
  "img": "icons/svg/dice-target.svg",
  "scope": "global",
  "command": "const characterGenerator = game.pirateborg.api.characterGenerator;\n\nconst tallTaleRollPack = 'pirateborg.rolls-tall-tale';\nconst tallTaleRollPackName = 'Tall Tale';\nconst aquaticMutantRollPackName = 'Aquatic Mutant';\nconst sentientAnimalRollPackName = 'Sentient Animal';\n\nconst getRandomBaseClass = () => {\n const validBaseClasses = selectedClasses.filter((selectedClass) => !selectedClass.requireBaseClass);\n return baseClass = validBaseClasses[Math.floor(Math.random() * validBaseClasses.length)];\n}\n\nconst getClassItems = async (selectedClass) => {\n return [\n ...(await characterGenerator.rollRollItems(selectedClass.startingRolls)),\n ...(await game.pirateborg.api.compendium.findItemsFromCompendiumString(selectedClass.startingItems)),\n ];\n}\n\nconst getStartingBonusItems = async (items) => {\n return [\n ...(await characterGenerator.findStartingBonusItems(items)),\n ...(await characterGenerator.findStartingBonusRollsItems(items)),\n ];\n}\n\nconst getPirateDataWithBaseClass = async (additionalItems = []) => {\n const baseClass = getRandomBaseClass(); \n const pirateData = await characterGenerator.rollCharacterForClass(baseClass);\n const items = await getClassItems(selectedClass); \n const bonusItems = await getStartingBonusItems([...items, ...additionalItems]);\n baseClass.isBaseClass = true;\n\n pirateData.items = pirateData.items\n .filter((item) => item.type !== 'class')\n .concat(items)\n .concat(additionalItems)\n .concat(bonusItems)\n .concat([baseClass])\n .concat([selectedClass]);\n\n return pirateData;\n}\n\nconst animalDefaultData = {\n startingAbilityScoreFormula: '3d6',\n startingStrengthBonus: -2,\n startingAgilityBonus: -2,\n startingPresenceBonus: -2,\n startingToughnessBonus: -2,\n startingSpiritBonus: -2,\n luckDie: '1d4',\n flavorText: '',\n startingMacro: '',\n}\n\nconst createSentientAnimalData = async (data) => {\n return foundry.utils.mergeObject(animalDefaultData, data, { insertKeys: true });\n}\n\nconst getMerfolkData = async (tallTaleItem) => {\n const pirateData = await getPirateDataWithBaseClass();\n pirateData.description = `<p>${tallTaleItem.flavorText}</p>${pirateData.description}`\n pirateData.actorImg = tallTaleItem.img;\n\n const selectedClass = pirateData.items.find((item) => item.type === 'class' && item.isBaseClass === false);\n\n if (selectedClass.system) {\n   selectedClass.name = `${selectedClass.name} - ${tallTaleItem.name}`;\n } else {\n   selectedClass.data.name = `${selectedClass.data.name} - ${tallTaleItem.data.name}`;\n }\n\n return pirateData;\n}\n\nconst getAquaticMutantData = async (tallTaleItem) => {\n const aquaticMutantItem = (await game.pirateborg.api.compendium.drawTableItem(tallTaleRollPack, aquaticMutantRollPackName))[0];\n const pirateData = await getPirateDataWithBaseClass([aquaticMutantItem]);\n pirateData.description = `<p>${tallTaleItem.flavorText} (${aquaticMutantItem.name})</p>${pirateData.description}`\n\n if (aquaticMutantItem.name === 'Electric Eel') {\n pirateData.agility = parseInt(pirateData.agility, 10) + 1;\n }\n pirateData.actorImg = aquaticMutantItem.img;\n const selectedClass = pirateData.items.find((item) => item.type === 'class' && item.isBaseClass === false);\n\n\n if (selectedClass.system) {\n   selectedClass.name = `${selectedClass.name} - ${tallTaleItem.name} - ${aquaticMutantItem.name}`;\n } else {\n   selectedClass.data.name = `${selectedClass.data.name} - ${tallTaleItem.data.name} - ${aquaticMutantItem.data.name}`;\n }\n\n if(aquaticMutantItem.name === 'The Great Old One') {\n pirateData.items\n .filter((item) => item.type === 'invokable')\n .forEach((item) => {\n item.isEquipment = false;\n });\n }\n\n return pirateData;\n}\n\nconst getSentientAnimalData = async (tallTaleItem) => {\n const sentientAnimalItem = (await game.pirateborg.api.compendium.drawTableItem(tallTaleRollPack, sentientAnimalRollPackName))[0];\n let data = {};\n switch (sentientAnimalItem.name) {\n case 'Foul Fowl':\n data = await createSentientAnimalData({\n startingSpiritBonus: +3,\n startingHitPoints: '1d4', \n }); \n break;\n case 'Jaguar':\n data = await createSentientAnimalData({\n startingAgilityBonus: +2,\n startingStrengthBonus: +2,\n startingHitPoints: '1d8', \n });\n break;\n case 'Crocodile':\n data = await createSentientAnimalData({\n startingToughnessBonus: +1,\n startingStrengthBonus: +3,\n startingHitPoints: '1d10', \n });\n break;\n case 'Bilge Rat':\n data = await createSentientAnimalData({\n startingToughnessBonus: +2,\n startingAgilityBonus: +3,\n startingHitPoints: '1d2', \n });\n break;\n case 'Lucky Parrot':\n data = await createSentientAnimalData({\n startingPresenceBonus: +2,\n startingAgilityBonus: +1,\n startingHitPoints: '1d2', \n luckDie: '1d6'\n });\n break;\n case 'Clever Monkey':\n data = await createSentientAnimalData({\n startingPresenceBonus: 0,\n startingAgilityBonus: +2,\n startingStrengthBonus: -1,\n startingHitPoints: '1d6', \n startingWeaponTableFormula: '1d10',\n });\n break; \n }\n\n if (selectedClass.system) {\n selectedClass.system = {...selectedClass.system, ...data};\n } else {\n selectedClass.data.data = {...selectedClass.data.data, ...data};\n }\n\n\n if (selectedClass.system) {\n  selectedClass.name = `${selectedClass.name} - ${tallTaleItem.name} - ${sentientAnimalItem.name}`;\n  selectedClass.img = sentientAnimalItem.img;\n } else {\n  selectedClass.data.name = `${selectedClass.data.name} - ${tallTaleItem.data.name} - ${sentientAnimalItem.data.name}`;\n  selectedClass.data.img = sentientAnimalItem.data.img;\n }\n\n selectedClass.getData().startingRolls = sentientAnimalItem.startingBonusRolls;\n selectedClass.getData().startingItems = sentientAnimalItem.startingBonusItems;\n selectedClass.getData().flavorText = `${tallTaleItem.flavorText} (${sentientAnimalItem.name})`\n\n console.log(selectedClass);\n\n const pirateData = await characterGenerator.rollCharacterForClass(selectedClass);\n\n if(sentientAnimalItem.name === 'Foul Fowl') {\n pirateData.items\n .filter((item) => item.type === 'invokable')\n .forEach((item) => {\n item.getData().isEquipment = false;\n });\n }\n\n pirateData.items = pirateData.items.concat([sentientAnimalItem]);\n return pirateData;\n}\n\n\nconst tallTaleItem = (await game.pirateborg.api.compendium.drawTableItem(tallTaleRollPack, tallTaleRollPackName))[0];\n\nconsole.log(\"tallTaleItem\", tallTaleItem);\n\nlet pirateData = {};\n\nswitch (tallTaleItem.name) {\n case 'Merfolk':\n pirateData = await getMerfolkData(tallTaleItem);\n break;\n case 'Aquatic Mutant':\n pirateData = await getAquaticMutantData(tallTaleItem);\n break;\n case 'Sentient Animal':\n pirateData = await getSentientAnimalData(tallTaleItem);\n break;\n}\n\npirateData.items = pirateData.items.concat([tallTaleItem])\n\nconsole.log(\"pirateData\", pirateData);\n\nif (actor) {\n await characterGenerator.updateActorWithCharacter(actor, pirateData);\n} else {\n await characterGenerator.createActorWithCharacter(pirateData);\n}",
  "folder": null,
  "sort": 0,
  "flags": {},
  "ownership": {
    "default": 0
  },
  "_key": "!macros!euVqlYfll65zKOew"
}
